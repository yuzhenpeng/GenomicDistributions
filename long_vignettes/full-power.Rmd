---
title: "Full power GenomicDistributions"
author: "Nathan Sheffield"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{2. Full power GenomicDistributions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
# These settings make the vignette prettier
knitr::opts_chunk$set(results="hold", collapse=FALSE, message=FALSE)
#refreshPackage("GenomicDistributions")
#devtools::build_vignettes("code/GenomicDistributions")
#devtools::test("code/GenomicDistributions")
```

# Full power GenomicDistributions

This vignette shows how to use GenomicDistributions of full-size data. It is pre-computed. 

```{r, echo=FALSE}
# These settings make the vignette prettier
knitr::opts_chunk$set(results="hold", collapse=FALSE, message=FALSE)
#refreshPackage("GenomicDistributions")
#devtools::build_vignettes("code/GenomicDistributions")
#devtools::test("code/GenomicDistributions")
```

# Introduction

Welcome to the GenomicDistributions benchmarking.

Here's what you need to have installed:

```{r, install, eval=FALSE}
BiocManager::install("ChIPpeakAnno")
# BiocManager::install("EnsDb.Hsapiens.v75") # hg19
BiocManager::install("EnsDb.Hsapiens.v86") # hg38
devtools::install_github("databio/GenomicDistributions")
devtools::install_github("databio/GenomicDistributionsData")
install.packages("http://big.databio.org/GenomicDistributionsData/GenomicDistributionsData_0.0.1.tar.gz", repos=NULL)
install.packages("~/code/GenomicDistributionsData", repos=NULL)
```


```{r, initialize}
library(microbenchmark)
library(GenomicDistributions)
library(ChIPpeakAnno)
# library(EnsDb.Hsapiens.v75) # hg19
library(EnsDb.Hsapiens.v86) # hg38

## create annotation file from EnsDb or TxDb
annoData <- toGRanges(EnsDb.Hsapiens.v86, feature="gene")
annoData[1:2]
```

Let's retrieve a variety of ENCODE BED files and use BiocFileCache to download them here:

```{r, download-data}
if (interactive()) setwd("long_vignettes")  # run this from GenomicDistributions/long_vignettes
path = getwd()
message(getwd())
bfc = BiocFileCache::BiocFileCache(getwd())
rpath = function(url, bfc) {
	message("Downloading ", url)
	BiocFileCache::bfcrpath(bfc, url)
}

urls = c(
	H1_REST="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE101nnn/GSE101251/suppl/GSE101251_ENCFF235EJG_peaks_GRCh38.bed.gz",
	MCF7_CTCF="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE123nnn/GSE123219/suppl/GSE123219_ENCFF047HAG_conservative_idr_thresholded_peaks_GRCh38.bed.gz",
	K562_H3K4me3="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE96nnn/GSE96303/suppl/GSE96303_ENCFF616DLO_replicated_peaks_GRCh38.bed.gz",
	GM12878_H3K4me3="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE95nnn/GSE95899/suppl/GSE95899_ENCFF188SZS_replicated_peaks_GRCh38.bed.gz",
	K562_ZEB2="http://big.databio.org/example_data/bedbase_tutorial/bed_files/GSE91663_ENCFF316ASR_peaks_GRCh38.bed.gz", 
	HEK293_GLI2="http://big.databio.org/example_data/bedbase_tutorial/bed_files/GSE105977_ENCFF617QGK_optimal_idr_thresholded_peaks_GRCh38.bed.gz",
	K562_ZEB2_TOP="http://big.databio.org/example_data/bedbase_tutorial/bed_files/GSE91663_ENCFF319TPR_conservative_idr_thresholded_peaks_GRCh38.bed.gz",
	GLIAL_H3K27me3="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE95nnn/GSE95927/suppl/GSE95927_ENCFF724DGK_replicated_peaks_GRCh38.bed.gz",
	A673_H3K27me3="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE96nnn/GSE96349/suppl/GSE96349_ENCFF412EXZ_peaks_GRCh38.bed.gz",
	A673_H3K27ac="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE96nnn/GSE96332/suppl/GSE96332_ENCFF529ISR_peaks_GRCh38.bed.gz",
	A673_H3K4me1="https://ftp.ncbi.nlm.nih.gov/geo/series/GSE96nnn/GSE96216/suppl/GSE96216_ENCFF328DBS_peaks_GRCh38.bed.gz",
	A549_JUN="https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2437nnn/GSM2437721/suppl/GSM2437721_ENCFF064QGH_peaks_GRCh38.bed.gz",
	A549_H3K27ac="https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM2421nnn/GSM2421593/suppl/GSM2421593_ENCFF715EXP_peaks_GRCh38.bed.gz")
bedpaths = lapply(urls, rpath, bfc)
```

Read these  file in and build a GenomicRanges object:

```{r load-data-to-granges}

df = lapply(bedpaths, data.table::fread)
gr1 = GenomicDistributions:::dtToGr(df[[1]], chr="V1", start="V2", end="V3")

grs = lapply(df, GenomicDistributions:::dtToGr, chr="V1", start="V2", end="V3")
grs = lapply(grs, sort)
queryList = GRangesList(grs)
```

Set up benchmarking functions:

```{r feature-plots}
TSSdist = calcFeatureDist(queryList, sort(annoData))
p = plotFeatureDist(TSSdist, featureName="TSS", tile=TRUE)
print(p)
```

```{r partition-plots}
perc2 = calcPartitionsRef(queryList, "hg38")
p = plotPartitions(perc2)
print(p)

ep2 = calcExpectedPartitionsRef(queryList, "hg38")
plotExpectedPartitions(ep2)

cp2 = calcCumulativePartitionsRef(queryList, "hg38")
plotCumulativePartitions(cp2)
```

```{r}
# gc2 = calcGCContentRef(queryList, "hg38")
# plotGCContent(gc2)

chromBins = calcChromBinsRef(queryList, "hg38")
# Then, plot the result:
plotChromBins(chromBins[!grepl("_", chr, fixed=TRUE),])
```

```{r}

library(GenomicDistributionsData)
data(openSignalMatrix_hg38)

openSignalMatrix_hg38

op = calcOpenSignal(queryList, openSignalMatrix_hg38)
opp = plotOpenSignal(op)
op


nd = calcNeighborDist(queryList)

# Plot the distribution
plotNeighborDist(nd)

qt2 = calcWidth(queryList)
plotQTHist(qt2, bins=15)


```


